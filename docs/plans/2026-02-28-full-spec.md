# IAP System — Technical Specification

**Version:** 2.0
**Status:** Ready for Development
**Last Updated:** 2026-02-28
**Author:** Architecture Team

---

## Table of Contents

1. [Overview](#1-overview)
2. [Architecture](#2-architecture)
3. [Technology Stack](#3-technology-stack)
4. [Filesystem Structure](#4-filesystem-structure)
5. [Database Schema](#5-database-schema)
6. [API Specification](#6-api-specification)
7. [Security & Rate Limiting](#7-security--rate-limiting)
8. [VPS Deployment](#8-vps-deployment)
9. [Testing Strategy](#9-testing-strategy)
10. [Monitoring & Observability](#10-monitoring--observability)
11. [Development Phases](#11-development-phases)
12. [Appendices](#appendices)

---

## 1. Overview

### 1.1 Purpose

Build a standalone In-App Purchase (IAP) system for iOS and Android that handles subscriptions, payments, verification, and analytics.

### 1.2 Goals

- Native IAP purchases via `react-native-iap`
- Server-side receipt verification via `go-iap`
- Billing management via `Lago`
- Revenue tracking and analytics
- Grace period, winback, and churn prediction
- A/B testing for paywalls

### 1.3 Key Principles

- Mobile app sends events only; no business logic on the client
- Go API makes all decisions
- Workers compute analytics on a schedule
- All external service calls have a defined degradation behavior
- No purchase is lost due to transient third-party unavailability

---

## 2. Architecture

### 2.1 High-Level Diagram

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Mobile App     │     │   Go Backend    │     │  External SVCS  │
│  React Native   │────▶│   API + Worker  │────▶│  Apple/Google   │
│  react-native-iap│    │   + go-iap      │     │  Lago/Stripe    │
└─────────────────┘     └────────┬────────┘     └─────────────────┘
                                 │
                          ┌──────▼──────┐
                          │  PostgreSQL │
                          │    Redis    │
                          └─────────────┘
```

### 2.2 Layer Architecture (Clean Architecture)

```
┌─────────────────────────────────────────────────────────────┐
│                    PRESENTATION LAYER                        │
│  HTTP Handlers / Webhooks / Middleware                       │
├─────────────────────────────────────────────────────────────┤
│                    APPLICATION LAYER                         │
│  Use Cases / Commands / Queries / DTOs / Events              │
├─────────────────────────────────────────────────────────────┤
│                      DOMAIN LAYER                            │
│  Entities / Value Objects / Repository Interfaces / Services │
├─────────────────────────────────────────────────────────────┤
│                   INFRASTRUCTURE LAYER                       │
│  DB / Redis / External APIs (Lago, go-iap, Stripe)           │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 Dependency Rule

```
Presentation → Application → Domain ← Infrastructure
                     ↓              ↑
                     └──────────────┘
          (Infrastructure implements Domain interfaces)
```

---

## 3. Technology Stack

### 3.1 Backend (Go)

| Component | Technology | Version | Purpose | File Location |
|-----------|------------|---------|---------|---------------|
| **Language** | Go | 1.21+ | API + Workers | `backend/` |
| **HTTP Framework** | Gin | 1.9+ | REST API router | `backend/internal/interfaces/http/router.go` |
| **IAP Verification** | go-iap | 1.43+ | Receipt validation | `backend/internal/infrastructure/external/iap/` |
| **DB Driver** | pgx/v5 | 5.5+ | PostgreSQL driver | `backend/internal/infrastructure/persistence/` |
| **SQL Codegen** | sqlc | 1.25+ | Type-safe query generation (dev tool) | `backend/internal/infrastructure/persistence/sqlc/` |
| **Cache** | Redis | 7.2+ | Rate limiting, sessions, job queue | `backend/internal/infrastructure/cache/` |
| **Rate Limiter** | go-redis/redis_rate | 10.x | Token bucket algorithm | `backend/internal/infrastructure/cache/rate_limiter/` |
| **Job Queue** | Asynq | 0.24+ | Background jobs with retry/DLQ | `backend/cmd/worker/` |
| **JWT** | golang-jwt/jwt | 5.x | Authentication | `backend/internal/application/middleware/` |
| **Logger** | Zap | 1.26+ | Structured JSON logging | `backend/internal/infrastructure/logging/` |
| **Metrics** | Prometheus client | 1.17+ | Business + technical metrics | `backend/internal/infrastructure/metrics/` |
| **Config** | Viper | 1.18+ | ENV management | `backend/internal/infrastructure/config/` |
| **Migrations** | golang-migrate | 4.17+ | Schema evolution | `backend/migrations/` |

> **ADR-004:** sqlc + pgx replaces Prisma Client Go. Prisma Client Go runs a Node.js query engine sidecar (~200MB per process) incompatible with 512MB API container limits and introduces Node.js as a Go service runtime dependency. sqlc generates type-safe Go from raw SQL at build time with zero runtime overhead.

### 3.2 Frontend (React Native)

| Component | Technology | Version | Purpose | File Location |
|-----------|------------|---------|---------|---------------|
| **Framework** | React Native | 0.73+ | Mobile app | `mobile/` |
| **IAP SDK** | react-native-iap | 10.x | Native purchases | `mobile/src/infrastructure/iap/` |
| **Language** | TypeScript | 5.3+ | Type safety | `mobile/tsconfig.json` |
| **State** | Zustand | 4.5+ | State management | `mobile/src/application/stores/` |
| **HTTP Client** | Axios | 1.6+ | API requests | `mobile/src/infrastructure/api/` |
| **Storage** | react-native-secure-storage | 2.0+ | Encrypted tokens | `mobile/src/infrastructure/storage/` |
| **Navigation** | React Navigation | 6.x | Screen navigation | `mobile/src/presentation/navigation/` |
| **Testing** | Jest + Detox | 29.x + 20.x | Unit + E2E tests | `mobile/tests/` |
| **Analytics** | Mixpanel/Amplitude | latest | Event tracking | `mobile/src/infrastructure/analytics/` |

### 3.3 Infrastructure

| Component | Technology | Version | Purpose | File Location |
|-----------|------------|---------|---------|---------------|
| **Database** | PostgreSQL | 15.4+ | Primary storage | `infra/docker-compose.yml` |
| **Cache** | Redis | 7.2+ | Rate limiting, queue | `infra/docker-compose.yml` |
| **Web Server** | Nginx | 1.25+ | Reverse proxy, SSL | `infra/nginx/` |
| **SSL** | Let's Encrypt | - | TLS certificates | `infra/ssl/certbot/` |
| **Container** | Docker | 24+ | Deployment | `infra/docker/` |
| **Orchestration** | Docker Compose | 2.23+ | VPS deployment | `infra/docker-compose/` |
| **Monitoring** | Prometheus | 2.47+ | Metrics collection | `infra/monitoring/prometheus/` |
| **Dashboards** | Grafana | 10.2+ | Visualization | `infra/monitoring/grafana/` |
| **Exporters** | postgres_exporter | 0.15+ | DB metrics | `infra/monitoring/exporters/` |
| **Exporters** | redis_exporter | 1.54+ | Redis metrics | `infra/monitoring/exporters/` |
| **Backup** | pg_dump + S3 + AES-256 | - | Encrypted DB backups | `infra/scripts/backup/` |
| **CI/CD** | GitHub Actions | - | Build & deploy | `.github/workflows/` |
| **Security** | Fail2Ban | 0.12+ | SSH/HTTP protection | VPS level |
| **mTLS** | OpenSSL | 3.0+ | Server-to-server mutual TLS | `infra/ssl/mtls/` |

### 3.4 External Services

| Service | Provider | Purpose | Integration Point |
|---------|----------|---------|-------------------|
| **Billing** | Lago | Subscription management | `backend/internal/infrastructure/external/lago/` |
| **App Store** | Apple | iOS IAP verification | `backend/internal/infrastructure/external/iap/apple_verifier.go` |
| **Play Store** | Google | Android IAP verification | `backend/internal/infrastructure/external/iap/google_verifier.go` |
| **Web Payments** | Stripe/Paddle | External checkout | `backend/internal/infrastructure/external/stripe/` |
| **Object Storage** | AWS S3 | Encrypted backup storage | `infra/scripts/backup/daily-backup.sh` |
| **DNS/CDN** | Cloudflare | DDoS protection | Layer 1 security |
| **Error Tracking** | Sentry | Error monitoring | `backend/internal/infrastructure/logging/sentry_integration.go` |

### 3.5 Testing Stack

| Type | Tool | Version | Coverage | Location |
|------|------|---------|----------|----------|
| **Unit (Backend)** | Go testing | 1.21+ | Domain + Application | `backend/tests/unit/` |
| **Unit (Mobile)** | Jest | 29.x | Components + Hooks | `mobile/tests/unit/` |
| **Integration** | Testcontainers | 0.26+ | API + DB | `backend/tests/integration/` |
| **E2E (Mobile)** | Detox | 20.x | Full user flows | `mobile/tests/e2e/` |
| **Load Testing** | k6 | 0.49+ | Rate limit validation | `backend/tests/load/` |
| **Static Analysis** | golangci-lint | 1.55+ | Code quality | `backend/.golangci.yml` |
| **API Contract** | OpenAPI Generator | 7.2+ | Type-safe clients | `scripts/dev/generate-api-client.sh` |

### 3.6 Development Tools

| Tool | Purpose | Location |
|------|---------|----------|
| **Make** | Build automation | `backend/Makefile` |
| **Pre-commit** | Git hooks | `.pre-commit-config.yaml` |
| **EditorConfig** | Code style | `.editorconfig` |
| **Docker Dev** | Local environment | `infra/docker-compose/docker-compose.dev.yml` |
| **sqlc** | Query codegen | `backend/internal/infrastructure/persistence/sqlc/` |

### 3.7 VPS Requirements

| Resource | Minimum | Recommended | Notes |
|----------|---------|-------------|-------|
| **CPU** | 2 cores | 4 cores | Go + PostgreSQL + Redis |
| **RAM** | 4 GB | 8 GB | Memory limits enforced in Docker |
| **Storage** | 40 GB SSD | 80 GB SSD | DB + logs + backups |
| **Bandwidth** | 1 TB | Unlimited | API traffic + webhooks |
| **OS** | Ubuntu 22.04 LTS | Ubuntu 22.04 LTS | Long-term support |

**Memory budget (8GB VPS):**

| Service | Allocation |
|---------|-----------|
| PostgreSQL | 2 GB |
| Redis | 512 MB |
| Nginx | 64 MB |
| Prometheus + Grafana | 512 MB |
| Go API (2 replicas) | 512 MB × 2 |
| Go Worker | 256 MB |
| OS + headroom | 1 GB |
| **Total** | **~5.4 GB** |

### 3.8 Key Library Versions (go.mod)

```go
// backend/go.mod
require (
    github.com/gin-gonic/gin v1.9.1
    github.com/go-redis/redis_rate/v10 v10.0.1
    github.com/golang-jwt/jwt/v5 v5.2.0
    github.com/jackc/pgx/v5 v5.5.0
    github.com/hibiken/asynq v0.24.1
    github.com/robfig/cron/v3 v3.0.1
    github.com/stretchr/testify v1.8.4
    go.uber.org/zap v1.26.0
    github.com/prometheus/client_golang v1.17.0
    github.com/smartystreets/go-iap v1.43.0
    github.com/spf13/viper v1.18.0
    github.com/golang-migrate/migrate/v4 v4.17.0
)
```

> **Note:** `github.com/sirupsen/logrus` is explicitly excluded. All logging uses Zap. Any import of logrus in a PR MUST be rejected at review.

### 3.9 Key Package Versions (package.json)

```json
{
  "dependencies": {
    "react-native": "0.73.2",
    "react-native-iap": "10.10.0",
    "zustand": "4.5.0",
    "axios": "1.6.5",
    "react-native-secure-storage": "2.0.1",
    "@react-navigation/native": "6.1.9"
  },
  "devDependencies": {
    "jest": "29.7.0",
    "detox": "20.17.0",
    "typescript": "5.3.3"
  }
}
```

### 3.10 Architectural Decision Records Summary

| ADR # | Decision | Rationale |
|-------|----------|-----------|
| 001 | Go for backend | Performance, concurrency, go-iap native support |
| 002 | Lago for billing | Open-source, self-hostable, flexible pricing |
| 003 | go-iap for receipt verification | Native Go, Apple + Google support |
| 004 | sqlc + pgx over Prisma Client Go | No sidecar overhead, production-safe, type-safe SQL |
| 005 | Docker Compose over K8s | VPS simplicity, no orchestration overhead |
| 006 | Redis for rate limiting | Atomic operations, shared state across instances |
| 007 | Asynq over raw Redis queue | Built-in retry, DLQ, job deduplication, visibility timeout |
| 008 | Clean Architecture | Testability, separation of concerns |
| 009 | Zustand over Redux | Less boilerplate, React Native compatible |
| 010 | Gin over Echo | Middleware ecosystem, performance |

---

## 4. Filesystem Structure

```
iap-system/
├── .github/
│   ├── workflows/
│   │   ├── backend-ci.yml                    # Go lint, test, build, security scan
│   │   ├── mobile-ci.yml                     # RN lint, test, build, E2E
│   │   ├── deploy-vps.yml                    # SSH deploy (non-root) with migration step
│   │   ├── backup-verify.yml                 # Weekly backup restoration test
│   │   └── security-audit.yml                # Dependency vulnerability scan
│   ├── ISSUE_TEMPLATE/
│   │   ├── bug_report.md
│   │   ├── feature_request.md
│   │   └── security_report.md
│   ├── PULL_REQUEST_TEMPLATE.md
│   └── CODEOWNERS
│
├── docs/
│   ├── architecture/
│   │   ├── system-overview.md
│   │   ├── clean-architecture-decision.md
│   │   ├── data-flow-diagram.md
│   │   └── deployment-topology.md
│   ├── api/
│   │   ├── openapi.yaml                      # 39 endpoints specification
│   │   ├── webhook-schemas/
│   │   │   ├── stripe-webhook-schema.json
│   │   │   ├── apple-webhook-schema.json
│   │   │   └── google-webhook-schema.json
│   │   └── rate-limit-matrix.md
│   ├── adr/
│   │   ├── 001-go-backend-selection.md
│   │   ├── 002-lago-billing-integration.md
│   │   ├── 003-go-iap-verification.md
│   │   ├── 004-sqlc-pgx-over-prisma.md
│   │   ├── 005-docker-compose-vps.md
│   │   ├── 006-redis-rate-limiting.md
│   │   ├── 007-asynq-job-queue.md
│   │   ├── 008-clean-architecture.md
│   │   ├── 009-mtls-scope.md
│   │   └── 010-identity-model.md
│   ├── database/
│   │   ├── schema-erd.md
│   │   ├── migration-strategy.md
│   │   └── backup-restore-procedure.md
│   ├── security/
│   │   ├── threat-model.md                   # STRIDE analysis
│   │   ├── compliance-checklist.md           # Apple/Google compliance + GDPR
│   │   └── incident-response.md
│   └── runbooks/
│       ├── deploy-procedure.md
│       ├── rollback-procedure.md
│       ├── database-emergency.md
│       └── security-breach-response.md
│
├── infra/
│   ├── docker/
│   │   ├── backend/
│   │   │   ├── Dockerfile                    # Multi-stage Go build
│   │   │   ├── Dockerfile.dev
│   │   │   └── .dockerignore
│   │   └── worker/
│   │       ├── Dockerfile
│   │       └── .dockerignore
│   ├── docker-compose/
│   │   ├── docker-compose.yml                # Production services
│   │   ├── docker-compose.dev.yml
│   │   ├── docker-compose.test.yml
│   │   └── docker-compose.monitoring.yml
│   ├── nginx/
│   │   ├── nginx.conf
│   │   └── conf.d/
│   │       ├── api-upstream.conf
│   │       ├── rate-limiting.conf
│   │       ├── ssl-params.conf               # TLS 1.3 only
│   │       └── security-headers.conf         # HSTS, CSP, X-Frame-Options
│   ├── scripts/
│   │   ├── backup/
│   │   │   ├── daily-backup.sh               # pg_dump → AES-256 encrypt → S3
│   │   │   ├── verify-backup.sh              # Restore and validate backup integrity
│   │   │   └── cleanup-old-backups.sh        # 30-day retention
│   │   ├── deploy/
│   │   │   ├── deploy-production.sh          # Migration-first zero-downtime deploy
│   │   │   ├── rollback.sh
│   │   │   └── health-check.sh
│   │   ├── database/
│   │   │   ├── migrate-up.sh
│   │   │   └── migrate-down.sh
│   │   └── security/
│   │       ├── renew-certificates.sh
│   │       ├── rotate-secrets.sh             # JWT key rotation (multi-key window)
│   │       └── audit-ssh-keys.sh
│   ├── monitoring/
│   │   ├── prometheus/
│   │   │   ├── prometheus.yml
│   │   │   └── rules/
│   │   │       ├── alerts.yml
│   │   │       └── recording-rules.yml
│   │   ├── grafana/
│   │   │   ├── dashboards/
│   │   │   │   ├── revenue-dashboard.json
│   │   │   │   ├── system-health.json
│   │   │   │   ├── api-performance.json
│   │   │   │   └── subscription-metrics.json
│   │   │   └── datasources/
│   │   │       └── prometheus.yml
│   │   └── exporters/
│   │       ├── postgres-exporter.yml
│   │       └── redis-exporter.yml
│   ├── ssl/
│   │   ├── certbot/
│   │   │   └── renewal-config.ini
│   │   └── mtls/
│   │       ├── generate-ca.sh                # Internal CA for server-to-server mTLS
│   │       ├── generate-client-certs.sh      # For Lago / admin services only
│   │       └── revoke-cert.sh
│   └── .env.example
│
├── backend/
│   ├── cmd/
│   │   ├── api/
│   │   │   ├── main.go
│   │   │   ├── wire.go                       # Dependency injection
│   │   │   └── shutdown.go                   # Graceful shutdown (30s timeout)
│   │   ├── worker/
│   │   │   ├── main.go
│   │   │   ├── server.go                     # Asynq server setup
│   │   │   └── jobs/
│   │   │       ├── churn_prediction_job.go
│   │   │       ├── winback_campaign_job.go
│   │   │       ├── revenue_aggregate_job.go
│   │   │       ├── grace_period_expiry_job.go
│   │   │       └── webhook_retry_job.go
│   │   └── migrator/
│   │       ├── main.go
│   │       └── migrate.go
│   │
│   ├── internal/
│   │   ├── domain/
│   │   │   ├── entity/
│   │   │   │   ├── user.go
│   │   │   │   ├── subscription.go
│   │   │   │   ├── transaction.go
│   │   │   │   ├── grace_period.go
│   │   │   │   ├── winback_campaign.go
│   │   │   │   ├── ab_test.go
│   │   │   │   ├── ab_test_assignment.go
│   │   │   │   ├── churn_prediction.go
│   │   │   │   ├── revenue_aggregate.go
│   │   │   │   ├── webhook_event.go          # Inbox table entity
│   │   │   │   ├── subscription_event.go     # Audit log entity
│   │   │   │   └── admin_user.go
│   │   │   ├── valueobject/
│   │   │   │   ├── money.go
│   │   │   │   ├── email.go
│   │   │   │   ├── plan_type.go
│   │   │   │   ├── subscription_status.go
│   │   │   │   ├── platform.go
│   │   │   │   ├── receipt_data.go
│   │   │   │   └── jwt_claims.go
│   │   │   ├── repository/
│   │   │   │   ├── user_repository.go
│   │   │   │   ├── subscription_repository.go
│   │   │   │   ├── transaction_repository.go
│   │   │   │   ├── grace_period_repository.go
│   │   │   │   ├── winback_campaign_repository.go
│   │   │   │   ├── ab_test_repository.go
│   │   │   │   ├── churn_prediction_repository.go
│   │   │   │   ├── revenue_aggregate_repository.go
│   │   │   │   ├── webhook_event_repository.go
│   │   │   │   ├── subscription_event_repository.go
│   │   │   │   ├── admin_user_repository.go
│   │   │   │   └── pricing_tier_repository.go
│   │   │   ├── service/
│   │   │   │   ├── pricing_service.go
│   │   │   │   ├── eligibility_service.go
│   │   │   │   ├── churn_risk_service.go     # Rule-based scoring
│   │   │   │   └── ab_test_service.go
│   │   │   ├── event/
│   │   │   │   ├── subscription_activated.go
│   │   │   │   ├── subscription_cancelled.go
│   │   │   │   ├── payment_failed.go
│   │   │   │   ├── grace_period_started.go
│   │   │   │   └── event_dispatcher.go
│   │   │   └── errors/
│   │   │       ├── domain_errors.go
│   │   │       └── validation_errors.go
│   │   │
│   │   ├── application/
│   │   │   ├── command/
│   │   │   │   ├── auth/
│   │   │   │   │   ├── register_user_command.go
│   │   │   │   │   ├── register_user_handler.go
│   │   │   │   │   ├── refresh_token_command.go
│   │   │   │   │   ├── refresh_token_handler.go
│   │   │   │   │   └── revoke_token_command.go   # Token revocation
│   │   │   │   ├── iap/
│   │   │   │   │   ├── verify_receipt_command.go
│   │   │   │   │   ├── verify_receipt_handler.go
│   │   │   │   │   └── restore_purchases_command.go
│   │   │   │   ├── subscription/
│   │   │   │   │   ├── create_subscription_command.go
│   │   │   │   │   ├── cancel_subscription_command.go
│   │   │   │   │   └── update_subscription_command.go
│   │   │   │   ├── payment/
│   │   │   │   │   └── create_payment_session_command.go
│   │   │   │   ├── grace_period/
│   │   │   │   │   ├── create_grace_period_command.go
│   │   │   │   │   ├── resolve_grace_period_command.go
│   │   │   │   │   └── extend_grace_period_command.go
│   │   │   │   ├── winback/
│   │   │   │   │   ├── create_winback_offer_command.go
│   │   │   │   │   └── accept_winback_offer_command.go
│   │   │   │   └── ab_test/
│   │   │   │       ├── assign_ab_test_command.go
│   │   │   │       └── track_ab_event_command.go
│   │   │   ├── query/
│   │   │   │   ├── subscription/
│   │   │   │   │   ├── get_subscription_query.go
│   │   │   │   │   └── check_access_query.go
│   │   │   │   ├── analytics/
│   │   │   │   │   ├── get_revenue_overview_query.go
│   │   │   │   │   ├── get_revenue_timeline_query.go
│   │   │   │   │   ├── get_cohort_retention_query.go
│   │   │   │   │   ├── get_conversion_funnel_query.go
│   │   │   │   │   └── get_ab_test_results_query.go
│   │   │   │   ├── churn/
│   │   │   │   │   └── get_churn_score_query.go
│   │   │   │   ├── grace_period/
│   │   │   │   │   └── get_grace_period_query.go
│   │   │   │   └── winback/
│   │   │   │       └── get_winback_offer_query.go
│   │   │   ├── dto/
│   │   │   │   ├── request/
│   │   │   │   ├── response/
│   │   │   │   └── mapper/
│   │   │   ├── middleware/
│   │   │   │   ├── authentication_middleware.go
│   │   │   │   ├── authorization_middleware.go  # RBAC enforcement
│   │   │   │   ├── rate_limit_middleware.go
│   │   │   │   ├── request_id_middleware.go
│   │   │   │   ├── logging_middleware.go
│   │   │   │   └── recovery_middleware.go
│   │   │   └── validator/
│   │   │       └── request_validator.go
│   │   │
│   │   ├── infrastructure/
│   │   │   ├── persistence/
│   │   │   │   ├── sqlc/
│   │   │   │   │   ├── sqlc.yaml             # sqlc configuration
│   │   │   │   │   ├── schema.sql            # Canonical schema (source of truth)
│   │   │   │   │   ├── queries/
│   │   │   │   │   │   ├── users.sql
│   │   │   │   │   │   ├── subscriptions.sql
│   │   │   │   │   │   ├── transactions.sql
│   │   │   │   │   │   ├── grace_periods.sql
│   │   │   │   │   │   ├── winback.sql
│   │   │   │   │   │   ├── ab_tests.sql
│   │   │   │   │   │   ├── churn.sql
│   │   │   │   │   │   ├── analytics.sql
│   │   │   │   │   │   ├── webhook_events.sql
│   │   │   │   │   │   └── admin.sql
│   │   │   │   │   └── generated/            # Auto-generated, do not edit
│   │   │   │   │       ├── db.go
│   │   │   │   │       ├── models.go
│   │   │   │   │       └── *.sql.go
│   │   │   │   ├── pool/
│   │   │   │   │   └── pgxpool.go            # Connection pool config
│   │   │   │   ├── repository/
│   │   │   │   │   ├── user_repository_impl.go
│   │   │   │   │   ├── subscription_repository_impl.go
│   │   │   │   │   ├── transaction_repository_impl.go
│   │   │   │   │   ├── grace_period_repository_impl.go
│   │   │   │   │   ├── winback_repository_impl.go
│   │   │   │   │   ├── ab_test_repository_impl.go
│   │   │   │   │   ├── churn_repository_impl.go
│   │   │   │   │   ├── revenue_aggregate_repository_impl.go
│   │   │   │   │   ├── webhook_event_repository_impl.go
│   │   │   │   │   └── admin_user_repository_impl.go
│   │   │   │   └── transaction/
│   │   │   │       └── transaction_manager.go
│   │   │   ├── cache/
│   │   │   │   ├── redis/
│   │   │   │   │   ├── client.go
│   │   │   │   │   └── health_check.go
│   │   │   │   ├── rate_limiter/
│   │   │   │   │   ├── redis_rate_limiter.go
│   │   │   │   │   └── endpoint_limits.go
│   │   │   │   └── repository/
│   │   │   │       ├── subscription_cache.go  # TTL: 5m
│   │   │   │       ├── access_check_cache.go  # TTL: 60s (hard limit)
│   │   │   │       ├── ab_assignment_cache.go # TTL: 24h
│   │   │   │       └── token_blocklist.go     # JWT revocation store
│   │   │   ├── external/
│   │   │   │   ├── lago/
│   │   │   │   │   ├── client.go
│   │   │   │   │   ├── circuit_breaker.go    # Failsafe: queue sync on outage
│   │   │   │   │   ├── subscription_adapter.go
│   │   │   │   │   ├── invoice_adapter.go
│   │   │   │   │   └── webhook_handler.go
│   │   │   │   ├── iap/
│   │   │   │   │   ├── verifier.go
│   │   │   │   │   ├── apple_verifier.go
│   │   │   │   │   ├── google_verifier.go
│   │   │   │   │   ├── fallback_cache.go     # 1h cache on verification outage
│   │   │   │   │   └── receipt_errors.go
│   │   │   │   ├── stripe/
│   │   │   │   │   ├── client.go
│   │   │   │   │   ├── payment_session.go
│   │   │   │   │   ├── webhook_handler.go
│   │   │   │   │   └── webhook_validator.go
│   │   │   │   └── paddle/
│   │   │   │       ├── client.go
│   │   │   │       ├── payment_session.go
│   │   │   │       └── webhook_handler.go
│   │   │   ├── logging/
│   │   │   │   ├── logger.go
│   │   │   │   ├── fields.go
│   │   │   │   └── sentry_integration.go
│   │   │   ├── metrics/
│   │   │   │   ├── prometheus.go
│   │   │   │   ├── counters.go
│   │   │   │   ├── histograms.go
│   │   │   │   └── gauges.go
│   │   │   └── config/
│   │   │       ├── config.go
│   │   │       ├── database_config.go        # Pool sizing included
│   │   │       ├── redis_config.go
│   │   │       ├── lago_config.go
│   │   │       ├── iap_config.go
│   │   │       ├── stripe_config.go
│   │   │       ├── jwt_config.go
│   │   │       └── mtls_config.go
│   │   │
│   │   └── interfaces/
│   │       ├── http/
│   │       │   ├── server.go
│   │       │   ├── router.go
│   │       │   ├── routes.go
│   │       │   ├── handlers/
│   │       │   │   ├── auth_handler.go
│   │       │   │   ├── iap_handler.go
│   │       │   │   ├── subscription_handler.go
│   │       │   │   ├── payment_handler.go
│   │       │   │   ├── grace_period_handler.go
│   │       │   │   ├── winback_handler.go
│   │       │   │   ├── analytics_handler.go
│   │       │   │   ├── churn_handler.go
│   │       │   │   ├── ab_test_handler.go
│   │       │   │   ├── pricing_handler.go
│   │       │   │   ├── notification_handler.go
│   │       │   │   └── admin_handler.go
│   │       │   ├── middleware/
│   │       │   │   ├── auth_middleware.go
│   │       │   │   ├── mtls_middleware.go    # Server-to-server routes only
│   │       │   │   ├── rate_limit_middleware.go
│   │       │   │   ├── cors_middleware.go
│   │       │   │   ├── request_id_middleware.go
│   │       │   │   └── panic_recovery_middleware.go
│   │       │   └── response/
│   │       │       ├── response_writer.go
│   │       │       ├── error_formatter.go
│   │       │       └── pagination.go
│   │       └── webhook/
│   │           ├── webhook_router.go
│   │           ├── handlers/
│   │           │   ├── stripe_webhook_handler.go
│   │           │   ├── apple_webhook_handler.go
│   │           │   ├── google_webhook_handler.go
│   │           │   └── lago_webhook_handler.go
│   │           ├── middleware/
│   │           │   ├── hmac_validator.go
│   │           │   ├── jws_validator.go
│   │           │   ├── ip_whitelist.go
│   │           │   └── idempotency.go        # WebhookEvent inbox check
│   │           └── events/
│   │               ├── stripe_events.go
│   │               ├── apple_events.go
│   │               └── google_events.go
│   │
│   ├── migrations/
│   │   ├── 001_create_users.up.sql
│   │   ├── 001_create_users.down.sql
│   │   ├── 002_create_subscriptions.up.sql
│   │   ├── 002_create_subscriptions.down.sql
│   │   ├── 003_create_transactions.up.sql
│   │   ├── 003_create_transactions.down.sql
│   │   ├── 004_create_grace_periods.up.sql
│   │   ├── 004_create_grace_periods.down.sql
│   │   ├── 005_create_winback_campaigns.up.sql
│   │   ├── 006_create_ab_tests.up.sql
│   │   ├── 007_create_churn_predictions.up.sql
│   │   ├── 008_create_revenue_aggregates.up.sql
│   │   ├── 009_create_pricing_tiers.up.sql
│   │   ├── 010_create_webhook_events.up.sql
│   │   ├── 011_create_subscription_events.up.sql
│   │   ├── 012_create_admin_users.up.sql
│   │   └── 013_create_indexes.up.sql
│   │
│   ├── tests/
│   │   ├── unit/
│   │   ├── integration/
│   │   ├── e2e/
│   │   ├── load/
│   │   ├── mocks/
│   │   └── testdata/
│   │
│   ├── pkg/
│   │   ├── errors/
│   │   ├── utils/
│   │   └── constants/
│   │
│   ├── go.mod
│   ├── go.sum
│   ├── Makefile
│   ├── .golangci.yml
│   └── README.md
│
├── mobile/
│   ├── src/
│   │   ├── domain/
│   │   ├── application/
│   │   ├── infrastructure/
│   │   ├── presentation/
│   │   └── utils/
│   ├── android/
│   ├── ios/
│   ├── tests/
│   ├── package.json
│   ├── tsconfig.json
│   └── README.md
│
├── scripts/
│   ├── dev/
│   │   ├── setup-local.sh
│   │   ├── seed-database.sh
│   │   └── generate-api-client.sh
│   └── production/
│       ├── deploy.sh
│       ├── rollback.sh
│       └── emergency-shutdown.sh
│
├── .env.example
├── .gitignore
├── .editorconfig
└── README.md
```

---

## 5. Database Schema

### 5.1 Tables (13 Total)

```
CORE (3):            users, subscriptions, transactions
RETENTION (1):       grace_periods
WINBACK (1):         winback_campaigns
A/B TESTING (3):     ab_tests, ab_test_assignments, ab_test_events
ANALYTICS (3):       revenue_aggregates, pricing_tiers, churn_predictions
AUDIT / INBOX (3):   webhook_events, subscription_events, admin_audit_logs
```

### 5.2 Schema (SQL — source of truth for sqlc)

```sql
-- ============================================================
-- CORE
-- ============================================================

CREATE TABLE users (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- Platform identity: Apple originalTransactionId or Google obfuscatedExternalAccountId.
    -- This is the canonical persistent identity that survives reinstalls and device resets.
    -- device_id is stored for analytics only and MUST NOT be used as a foreign key.
    platform_user_id    TEXT UNIQUE NOT NULL,
    device_id           TEXT,                    -- informational only
    platform            TEXT NOT NULL CHECK (platform IN ('ios', 'android')),
    app_version         TEXT NOT NULL,
    email               TEXT UNIQUE,             -- optional, for cross-device / web
    ltv                 NUMERIC(10,2) DEFAULT 0, -- updated by worker
    ltv_updated_at      TIMESTAMPTZ,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    deleted_at          TIMESTAMPTZ             -- GDPR soft delete
);

CREATE TABLE subscriptions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id),
    status          TEXT NOT NULL CHECK (status IN ('active', 'expired', 'cancelled', 'grace')),
    source          TEXT NOT NULL CHECK (source IN ('iap', 'stripe', 'paddle')),
    platform        TEXT NOT NULL CHECK (platform IN ('ios', 'android', 'web')),
    product_id      TEXT NOT NULL,
    plan_type       TEXT NOT NULL CHECK (plan_type IN ('monthly', 'annual', 'lifetime')),
    expires_at      TIMESTAMPTZ NOT NULL,
    auto_renew      BOOLEAN NOT NULL DEFAULT true,
    created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    deleted_at      TIMESTAMPTZ             -- GDPR soft delete
);

-- Enforce single active subscription per user across all sources
CREATE UNIQUE INDEX idx_subscriptions_one_active
    ON subscriptions(user_id)
    WHERE status = 'active' AND deleted_at IS NULL;

CREATE TABLE transactions (
    id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id             UUID NOT NULL REFERENCES users(id),
    subscription_id     UUID NOT NULL REFERENCES subscriptions(id),
    amount              NUMERIC(10,2) NOT NULL,
    currency            CHAR(3) NOT NULL,          -- ISO 4217
    status              TEXT NOT NULL CHECK (status IN ('success', 'failed', 'refunded')),
    -- receipt_data stores only a SHA-256 hash of the raw receipt for deduplication;
    -- the full encrypted receipt is stored as a webhook_event payload.
    receipt_hash        TEXT,
    provider_tx_id      TEXT,                      -- Apple/Google/Stripe transaction ID
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ============================================================
-- RETENTION
-- ============================================================

CREATE TABLE grace_periods (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id),
    subscription_id UUID NOT NULL REFERENCES subscriptions(id),
    started_at      TIMESTAMPTZ NOT NULL,
    expires_at      TIMESTAMPTZ NOT NULL,
    reason          TEXT NOT NULL CHECK (reason IN ('payment_failed', 'card_expired', 'other')),
    resolved        BOOLEAN NOT NULL DEFAULT false,
    resolved_at     TIMESTAMPTZ
);

-- ============================================================
-- WINBACK
-- ============================================================

CREATE TABLE winback_campaigns (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id),
    cancelled_at    TIMESTAMPTZ NOT NULL,
    -- days_since_cancel is NOT stored — computed at query time as:
    -- EXTRACT(DAY FROM now() - cancelled_at)
    discount_pct    NUMERIC(5,2) NOT NULL,
    offer_sent_at   TIMESTAMPTZ NOT NULL,
    status          TEXT NOT NULL CHECK (status IN ('pending', 'sent', 'accepted', 'ignored')),
    converted_at    TIMESTAMPTZ
);

-- ============================================================
-- A/B TESTING
-- ============================================================

CREATE TABLE ab_tests (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name        TEXT NOT NULL,
    started_at  TIMESTAMPTZ NOT NULL,
    ended_at    TIMESTAMPTZ,
    winner      TEXT CHECK (winner IN ('A', 'B', 'inconclusive')),
    confidence  NUMERIC(5,4)       -- e.g. 0.9500 = 95%
);

CREATE TABLE ab_test_assignments (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    test_id     UUID NOT NULL REFERENCES ab_tests(id),
    user_id     UUID NOT NULL REFERENCES users(id),
    "group"     TEXT NOT NULL CHECK ("group" IN ('A', 'B')),
    assigned_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    -- One assignment per user per test; prevents dual-group assignment
    UNIQUE (test_id, user_id)
);

CREATE TABLE ab_test_events (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    test_id     UUID NOT NULL REFERENCES ab_tests(id),
    user_id     UUID NOT NULL REFERENCES users(id),
    event       TEXT NOT NULL CHECK (event IN ('shown', 'purchased', 'cancelled')),
    revenue     NUMERIC(10,2),
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ============================================================
-- ANALYTICS
-- ============================================================

CREATE TABLE churn_predictions (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES users(id),
    risk_score      NUMERIC(4,3) NOT NULL CHECK (risk_score BETWEEN 0 AND 1),
    predicted_at    TIMESTAMPTZ NOT NULL,
    -- Structured factors, not opaque JSON.
    -- Schema: { days_inactive: int, failed_payments: int,
    --           engagement_score: float, subscription_age_days: int }
    factors         JSONB NOT NULL,
    created_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Time-series business aggregates, computed nightly by worker.
-- NOT per-user — used directly for dashboard queries.
CREATE TABLE revenue_aggregates (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    period_start    TIMESTAMPTZ NOT NULL,
    period_end      TIMESTAMPTZ NOT NULL,
    calculated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
    mrr             NUMERIC(12,2) NOT NULL,   -- Monthly Recurring Revenue
    arr             NUMERIC(12,2) NOT NULL,   -- Annual Run Rate
    active_count    INTEGER NOT NULL,
    new_count       INTEGER NOT NULL,
    churned_count   INTEGER NOT NULL,
    expansion_mrr   NUMERIC(12,2) NOT NULL,
    contraction_mrr NUMERIC(12,2) NOT NULL,
    UNIQUE (period_start, period_end)
);

CREATE TABLE pricing_tiers (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name        TEXT NOT NULL CHECK (name IN ('monthly', 'annual', 'lifetime')),
    base_price  NUMERIC(10,2) NOT NULL,
    currency    CHAR(3) NOT NULL,
    trial_days  INTEGER NOT NULL DEFAULT 7,
    is_popular  BOOLEAN NOT NULL DEFAULT false,
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- ============================================================
-- AUDIT / INBOX
-- ============================================================

-- Webhook inbox: idempotency and audit trail for all inbound events.
-- Processing flow:
--   1. INSERT ON CONFLICT DO NOTHING using (provider, event_id) unique key.
--   2. If rows_affected == 1: process the event.
--   3. If rows_affected == 0: duplicate — return 200 immediately.
--   4. On processing failure: update failed_at, increment retry_count.
--      Worker retries via asynq with exponential backoff.
CREATE TABLE webhook_events (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    provider        TEXT NOT NULL CHECK (provider IN ('stripe', 'apple', 'google', 'lago')),
    event_id        TEXT NOT NULL,             -- provider's idempotency key
    event_type      TEXT NOT NULL,
    payload         BYTEA NOT NULL,            -- raw encrypted payload for audit
    processed_at    TIMESTAMPTZ,
    failed_at       TIMESTAMPTZ,
    retry_count     INTEGER NOT NULL DEFAULT 0,
    error           TEXT,
    received_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (provider, event_id)
);

-- Immutable audit log of all subscription state transitions.
-- Written within the same DB transaction as the state change.
-- Required for billing dispute resolution.
CREATE TABLE subscription_events (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    subscription_id UUID NOT NULL REFERENCES subscriptions(id),
    event_type      TEXT NOT NULL,   -- activated | renewed | cancelled | grace_started | expired
    previous_status TEXT,
    new_status      TEXT NOT NULL,
    source          TEXT NOT NULL,   -- iap | stripe | webhook | admin | worker
    metadata        JSONB,
    occurred_at     TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Immutable audit log for all admin actions.
-- Written atomically with the action it records.
CREATE TABLE admin_audit_logs (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    admin_id    UUID NOT NULL,
    action      TEXT NOT NULL,   -- grant_subscription | revoke | extend_grace | etc.
    target_id   UUID,            -- affected user_id or entity id
    before_val  JSONB,
    after_val   JSONB,
    ip          INET NOT NULL,
    created_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE admin_users (
    id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email         TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,               -- bcrypt cost 12
    role          TEXT NOT NULL CHECK (role IN ('super_admin', 'ops', 'analyst', 'support')),
    last_login_at TIMESTAMPTZ,
    created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    deleted_at    TIMESTAMPTZ
);
```

### 5.3 Required Indexes

```sql
-- Hot path: access check (called on every content open)
CREATE INDEX idx_subscriptions_access
    ON subscriptions(user_id, status, expires_at)
    WHERE deleted_at IS NULL;

-- Grace period resolution worker
CREATE INDEX idx_grace_active
    ON grace_periods(user_id, resolved, expires_at)
    WHERE resolved = false;

-- Winback campaign targeting (days_since_cancel computed at query time)
CREATE INDEX idx_winback_pending
    ON winback_campaigns(status, cancelled_at)
    WHERE status IN ('pending', 'sent');

-- A/B test event aggregation
CREATE INDEX idx_ab_events ON ab_test_events(test_id, event, created_at);

-- Churn: latest prediction per user
CREATE INDEX idx_churn_latest
    ON churn_predictions(user_id, predicted_at DESC);

-- Transaction history
CREATE INDEX idx_transactions_user
    ON transactions(user_id, created_at DESC);

-- Webhook inbox: fast duplicate check
CREATE INDEX idx_webhook_unprocessed
    ON webhook_events(provider, received_at)
    WHERE processed_at IS NULL AND failed_at IS NULL;

-- Subscription audit log queries
CREATE INDEX idx_subscription_events
    ON subscription_events(subscription_id, occurred_at DESC);
```

---

## 6. API Specification

### 6.1 Base Configuration

```yaml
Base URL:
  Production: https://api.yourapp.com/v1
  Staging:    https://api.staging.yourapp.com/v1

Auth Model:
  Mobile endpoints:       TLS 1.3 + Certificate Pinning (client verifies server cert)
                          + JWT Bearer Token
  Server-to-server:       mTLS (Lago integration, internal admin services)
  Webhook endpoints:      IP Whitelist + HMAC-SHA256 or JWS (no JWT required)
  Admin endpoints:        Short-lived JWT (1h TTL) + RBAC role enforcement

JWT:
  Access token TTL:  15 minutes
  Refresh token TTL: 30 days, rotated on each use
  Claims:            { sub: user_id, jti: uuid, role: string, iat, exp }
  Revocation:        Redis blocklist keyed on jti, TTL = remaining token lifetime

Response Format:
  Success: { data: {...}, meta: { requestID: uuid, timestamp: iso8601 } }
  Error:   { error: string, message: string, code: string, requestID: uuid, timestamp: iso8601 }
```

### 6.2 Service Level Objectives

| Endpoint | P99 Latency | Notes |
|----------|-------------|-------|
| `/subscription/access` | < 50ms (cache hit) / < 200ms (miss) | Hot path — called on every content open |
| `/verify/iap` | < 3s | Includes Apple/Google round-trip |
| `/webhook/*` | < 500ms | Must respond before provider retry |
| `/analytics/*` | < 5s | Admin dashboard — acceptable latency |
| All others | < 500ms | |

**Availability target:** 99.9% (43.8 min/month budget)
**RPO:** 24 hours | **RTO:** 4 hours

### 6.3 All 39 Endpoints

#### AUTH (2 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/auth/register` | None | 5/min/IP | Register new user |
| POST | `/auth/refresh` | Refresh Token | 5/min/IP | Rotate access + refresh token pair |

#### VERIFICATION (1 endpoint)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/verify/iap` | JWT | 3/min/User | Verify IAP receipt — idempotent on receipt hash |

#### PAYMENT (2 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/payment/session` | JWT | 5/min/User | Create Stripe/Paddle checkout session |
| GET | `/payment/session/{id}` | JWT | 10/min/User | Poll session status |

#### SUBSCRIPTION (3 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/subscription` | JWT | 10/min/User | Get subscription details |
| GET | `/subscription/access` | JWT | 60/min/User | Quick access check (60s cache) |
| DELETE | `/subscription` | JWT | 3/min/User | Cancel subscription |

#### GRACE PERIOD (3 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/grace` | JWT | 10/min/User | Get grace period status |
| POST | `/grace/resolve` | JWT | 5/min/User | Resolve grace period (re-payment) |
| POST | `/grace/extend` | Admin JWT (ops) | 10/day | Extend grace period — admin only |

#### WINBACK (3 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/winback/offer` | JWT | 5/min/User | Get winback offer for eligible user |
| POST | `/winback/accept` | JWT | 3/min/User | Accept winback discount offer |
| GET | `/winback/status` | JWT | 10/min/User | Get winback campaign status |

#### PRICING (4 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/pricing/tiers` | None | 60/min/IP | Get all pricing tiers |
| GET | `/pricing/tiers/{id}` | None | 60/min/IP | Get single tier |
| POST | `/pricing/tiers` | Admin JWT (super_admin) | 10/day | Create tier |
| PATCH | `/pricing/tiers/{id}` | Admin JWT (super_admin) | 10/day | Update tier |

#### ANALYTICS (5 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/analytics/overview` | Admin JWT (analyst+) | 30/min | Revenue overview from aggregates |
| GET | `/analytics/revenue` | Admin JWT (analyst+) | 30/min | Revenue timeline |
| GET | `/analytics/cohorts` | Admin JWT (analyst+) | 30/min | Retention cohorts |
| GET | `/analytics/funnel` | Admin JWT (analyst+) | 30/min | Conversion funnel |
| GET | `/analytics/abtest/{id}` | Admin JWT (analyst+) | 30/min | A/B test results |

#### CHURN (1 endpoint)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/churn/score` | JWT | 5/min/User | Get user's churn risk score |

#### NOTIFICATIONS (3 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| POST | `/notifications/trigger` | Admin JWT (ops+) | 100/min | Trigger notification |
| GET | `/notifications/history` | JWT | 10/min/User | Get notification history |
| DELETE | `/notifications/unsubscribe` | JWT | 5/min/User | Unsubscribe from events |

#### A/B TESTING (3 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/ab/assignment` | JWT | 10/min/User | Get or create A/B assignment |
| POST | `/ab/event` | JWT | 50/min/User | Track A/B conversion event |
| GET | `/ab/tests` | Admin JWT (analyst+) | 30/min | List all tests |

#### ADMIN (6 endpoints)

| Method | Endpoint | Auth | Rate Limit | Description |
|--------|----------|------|------------|-------------|
| GET | `/admin/users` | Admin JWT (support+) | 30/min | List users |
| GET | `/admin/users/{id}` | Admin JWT (support+) | 30/min | Get user details |
| POST | `/admin/users/{id}/grant` | Admin JWT (ops+) | 10/day | Grant subscription — writes audit log |
| POST | `/admin/users/{id}/revoke` | Admin JWT (ops+) | 10/day | Revoke subscription — writes audit log |
| GET | `/admin/health` | Admin JWT | 60/min | System health check |
| GET | `/admin/queue` | Admin JWT (ops+) | 60/min | Asynq worker queue status |

#### WEBHOOKS (3 endpoints)

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/webhook/stripe` | IP Whitelist + HMAC-SHA256 | Stripe events — idempotent via webhook_events inbox |
| POST | `/webhook/apple` | IP Whitelist + JWS | Apple S2S notifications — idempotent |
| POST | `/webhook/google` | IP Whitelist + HMAC | Google RTDN — idempotent |

### 6.4 Error Codes

```yaml
400: INVALID_REQUEST, RECEIPT_INVALID, RECEIPT_DUPLICATE, RECEIPT_EXPIRED
401: UNAUTHORIZED, TOKEN_EXPIRED, TOKEN_REVOKED
403: FORBIDDEN, INSUFFICIENT_ROLE
404: NOT_FOUND, NO_SUBSCRIPTION, NO_GRACE_PERIOD
409: CONFLICT
422: UNPROCESSABLE
429: RATE_LIMIT_EXCEEDED
500: INTERNAL_ERROR
502: UPSTREAM_ERROR
503: SERVICE_UNAVAILABLE  # Returned during circuit-breaker open state
```

### 6.5 Rate Limit Headers

```http
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 45
X-RateLimit-Reset: 1709136000
Retry-After: 60  # Only on 429
```

---

## 7. Security & Rate Limiting

### 7.1 Three-Layer Protection

```
┌─────────────────────────────────────────────────────────┐
│  Layer 1: Cloudflare                                    │
│  - L3/L4 DDoS protection                                │
│  - IP reputation filtering                              │
│  - WAF rules                                            │
├─────────────────────────────────────────────────────────┤
│  Layer 2: Nginx                                         │
│  - Rate limit by IP (token bucket)                      │
│  - Connection limit                                     │
│  - TLS 1.3 termination                                  │
├─────────────────────────────────────────────────────────┤
│  Layer 3: Go Middleware                                  │
│  - Rate limit by userID (Redis-backed)                  │
│  - JWT validation + jti blocklist check                 │
│  - RBAC role enforcement                                │
│  - HMAC/JWS verification for webhooks                   │
│  - Webhook idempotency (inbox table)                    │
└─────────────────────────────────────────────────────────┘
```

### 7.2 Auth Model by Client Type

| Client | Transport | Identity | Notes |
|--------|-----------|----------|-------|
| iOS/Android app | TLS 1.3 + cert pinning | JWT Bearer | mTLS is NOT used — mobile cannot securely distribute client certs |
| Stripe/Apple/Google webhooks | TLS 1.3 | IP Whitelist + HMAC/JWS | No JWT |
| Lago (server-to-server) | mTLS | Client certificate | Internal CA |
| Admin dashboard/CLI | TLS 1.3 | Short-lived JWT (1h) + RBAC | Issued after password + TOTP |

### 7.3 JWT Token Revocation

All JWTs include a `jti` (JWT ID) claim. On logout, token theft detection, or password change, the `jti` is written to Redis with TTL equal to the token's remaining lifetime.

```go
// token_blocklist.go

const blockedKeyPrefix = "jwt:blocked:"

func (b *TokenBlocklist) Revoke(ctx context.Context, jti string, remainingTTL time.Duration) error {
    return b.redis.Set(ctx, blockedKeyPrefix+jti, "1", remainingTTL).Err()
}

func (b *TokenBlocklist) IsRevoked(ctx context.Context, jti string) (bool, error) {
    err := b.redis.Get(ctx, blockedKeyPrefix+jti).Err()
    if err == redis.Nil {
        return false, nil
    }
    return err == nil, err
}
```

Authentication middleware MUST check `IsRevoked` after signature validation. Redis unavailability MUST fail closed (reject the request) for this check — unlike rate limiting which fails open.

### 7.4 Admin RBAC

```
Roles (least privilege order):
  support    → read users, read subscription details
  analyst    → support + read analytics, read A/B tests
  ops        → analyst + grant/revoke subscriptions, extend grace, trigger notifications
  super_admin → ops + create/update pricing tiers, manage admin users
```

Admin JWT is issued with a `role` claim. Every state-changing admin handler MUST:
1. Validate the JWT role against the required minimum.
2. Write an `admin_audit_log` row within the same database transaction as the action.

### 7.5 Rate Limiting Rules

| Endpoint | Algorithm | Per IP | Per User | Burst |
|----------|-----------|--------|----------|-------|
| `/verify/iap` | Token Bucket | 5/min | 3/min | 2 |
| `/payment/session` | Sliding Window | 10/min | 5/min | 3 |
| `/ab/event` | Fixed Window | 100/min | 50/min | 10 |
| `/auth/register` | Exponential Backoff | 5/min | — | 1 |
| `/webhook/*` | IP Whitelist + HMAC | 200/min | — | — |

### 7.6 Webhook Security

```go
// Stripe / Paddle: HMAC-SHA256
// Constant-time comparison to prevent timing attacks
func verifyHMAC(payload []byte, signature, secret string) bool {
    mac := hmac.New(sha256.New, []byte(secret))
    mac.Write(payload)
    expected := hex.EncodeToString(mac.Sum(nil))
    return hmac.Equal([]byte(expected), []byte(signature))
}

// Apple: JWS (JWT signed by Apple's public key)
func verifyAppleJWS(signedPayload string, appleRootCerts []*x509.Certificate) (*ApplePayload, error) {
    // Verify certificate chain → extract leaf public key → verify JWT signature
}

// Google: Pub/Sub push with OIDC token verification
func verifyGooglePubSub(token string, audience string) error {
    // Verify OIDC token against Google's public keys
}
```

### 7.7 IP Allowlist for Webhooks

```yaml
Stripe:  ["54.187.174.169/32", "54.187.205.235/32", "54.187.205.236/32"]
Paddle:  ["34.232.58.13/32",   "34.232.58.14/32"]
Apple:   ["17.0.0.0/8"]
Google:  ["66.102.0.0/20",     "64.233.160.0/19"]
```

> This list MUST be kept current. Subscribe to provider IP change notifications. Stale entries are a silent DoS vector.

### 7.8 External Service Degradation Policy

| Service Unavailable | Behavior | Alert |
|---------------------|----------|-------|
| Apple verification | Serve last cached verification result (max 1h). Queue re-verification. Do NOT reject the purchase. | Warning after 5 min |
| Google verification | Same as Apple | Warning after 5 min |
| Lago API | Continue local subscription state. Queue Lago sync via Asynq. | Warning after 2 min |
| Redis (rate limiter) | Fail **open** — log exceeded rate limits but allow request through | Critical immediately |
| Redis (blocklist) | Fail **closed** — reject JWT validation. Return 503. | Critical immediately |
| PostgreSQL | Return 503 to all write endpoints. Return stale cached data for reads where available. | Critical immediately |

---

## 8. VPS Deployment

### 8.1 Docker Compose Configuration

```yaml
# infra/docker-compose/docker-compose.yml
version: '3.8'

services:
  api:
    image: registry.yourapp.com/iap-api:${IMAGE_TAG}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - LAGO_API_KEY=${LAGO_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - BACKUP_ENCRYPTION_KEY=${BACKUP_ENCRYPTION_KEY}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  worker:
    image: registry.yourapp.com/iap-worker:${IMAGE_TAG}
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  db:
    image: postgres:15-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_DB=${DB_NAME}
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 2G

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redisdata:/data
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 512M

  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/letsencrypt:ro
    depends_on:
      api:
        condition: service_healthy
    networks:
      - internal

volumes:
  pgdata:
  redisdata:

networks:
  internal:
    internal: true
```

### 8.2 Connection Pool Configuration

```go
// backend/internal/infrastructure/persistence/pool/pgxpool.go

func NewPool(ctx context.Context, cfg DatabaseConfig) (*pgxpool.Pool, error) {
    config, err := pgxpool.ParseConfig(cfg.URL)
    if err != nil {
        return nil, err
    }

    // Max connections: sized at 25 per API instance.
    // With 2 API replicas + 1 worker = 75 total.
    // Postgres default max_connections = 100 → leaves 25 for migrations/admin.
    config.MaxConns = 25
    config.MinConns = 5
    config.MaxConnLifetime = 1 * time.Hour
    config.MaxConnIdleTime = 30 * time.Minute
    config.HealthCheckPeriod = 30 * time.Second

    return pgxpool.NewWithConfig(ctx, config)
}
```

```go
// backend/internal/infrastructure/cache/redis/client.go

func NewClient(cfg RedisConfig) *redis.Client {
    return redis.NewClient(&redis.Options{
        Addr:         cfg.URL,
        Password:     cfg.Password,
        PoolSize:     20,
        MinIdleConns: 5,
        PoolTimeout:  3 * time.Second,
        ReadTimeout:  2 * time.Second,
        WriteTimeout: 2 * time.Second,
    })
}
```

### 8.3 Cache TTL Constants

```go
// backend/internal/infrastructure/cache/repository/ttls.go

const (
    // MUST NOT exceed 60s — stale access decisions let cancelled users
    // continue accessing content. Invalidated on any subscription state change.
    AccessCheckTTL = 60 * time.Second

    // Full subscription object — lower priority, longer TTL acceptable.
    SubscriptionDetailTTL = 5 * time.Minute

    // Winback offers change infrequently.
    WinbackOfferTTL = 15 * time.Minute

    // A/B assignments are immutable once created.
    ABTestAssignmentTTL = 24 * time.Hour

    // JWT blocklist entry TTL = remaining token lifetime (set per-token).
    // No constant — calculated from token expiry at revocation time.
)
```

### 8.4 Nginx Configuration

```nginx
# infra/nginx/nginx.conf
limit_req_zone $binary_remote_addr zone=api_ip:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=api_conn:10m;

server {
    listen 443 ssl http2;
    server_name api.yourapp.com;

    ssl_certificate     /etc/letsencrypt/live/api.yourapp.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourapp.com/privkey.pem;
    ssl_protocols       TLSv1.3;
    ssl_ciphers         TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256;
    ssl_session_timeout 1d;
    ssl_session_cache   shared:SSL:50m;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;

    limit_req  zone=api_ip burst=20 nodelay;
    limit_conn api_conn 20;

    location / {
        proxy_pass          http://api:8080;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout  30s;
        proxy_send_timeout  10s;
    }

    location = /health {
        access_log off;
        proxy_pass http://api:8080/health;
    }
}

server {
    listen 80;
    server_name api.yourapp.com;
    return 301 https://$host$request_uri;
}
```

### 8.5 Encrypted Backup Script

```bash
#!/bin/bash
# infra/scripts/backup/daily-backup.sh
set -euo pipefail

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="backup_${DATE}.sql.gz"
ENCRYPTED_FILE="${BACKUP_FILE}.enc"
TMP_DIR=$(mktemp -d)

cleanup() { rm -rf "$TMP_DIR"; }
trap cleanup EXIT

# 1. Dump and compress
pg_dump -h db -U "${DB_USER}" "${DB_NAME}" | gzip > "${TMP_DIR}/${BACKUP_FILE}"

# 2. Encrypt with AES-256-CBC before upload
openssl enc -aes-256-cbc -pbkdf2 -iter 100000 \
    -in  "${TMP_DIR}/${BACKUP_FILE}" \
    -out "${TMP_DIR}/${ENCRYPTED_FILE}" \
    -pass env:BACKUP_ENCRYPTION_KEY

# 3. Upload encrypted file with S3 server-side encryption
aws s3 cp "${TMP_DIR}/${ENCRYPTED_FILE}" \
    "s3://${BACKUP_BUCKET}/daily/${ENCRYPTED_FILE}" \
    --sse aws:kms \
    --sse-kms-key-id "${KMS_KEY_ID}"

# 4. Remove local plaintext and encrypted files (trap handles tmp dir)

# 5. Enforce 30-day retention
aws s3 ls "s3://${BACKUP_BUCKET}/daily/" | awk '{print $4}' | while read -r f; do
    file_date=$(echo "$f" | grep -oP '\d{8}')
    cutoff=$(date -d "30 days ago" +%Y%m%d)
    if [[ "$file_date" < "$cutoff" ]]; then
        aws s3 rm "s3://${BACKUP_BUCKET}/daily/${f}"
    fi
done

echo "Backup completed: ${ENCRYPTED_FILE}"
```

### 8.6 CI/CD Pipeline

```yaml
# .github/workflows/deploy-vps.yml
name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - run: make test
      - run: make lint

  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Build and push Docker images
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | \
            docker login registry.yourapp.com -u "${{ secrets.REGISTRY_USER }}" --password-stdin
          docker build -t registry.yourapp.com/iap-api:${GITHUB_SHA} \
            -f infra/docker/backend/Dockerfile ./backend
          docker build -t registry.yourapp.com/iap-worker:${GITHUB_SHA} \
            -f infra/docker/worker/Dockerfile ./backend
          docker push registry.yourapp.com/iap-api:${GITHUB_SHA}
          docker push registry.yourapp.com/iap-worker:${GITHUB_SHA}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: deploy           # Non-root restricted deploy user
          key: ${{ secrets.VPS_DEPLOY_KEY }}
          script: |
            set -euo pipefail
            cd /opt/iap-system
            export IMAGE_TAG="${{ github.sha }}"

            # Pull new images
            docker compose pull api worker

            # Step 1: Run migrations BEFORE switching traffic.
            # If migration fails, abort deploy — old version continues serving.
            docker compose run --rm \
              -e DATABASE_URL="${DATABASE_URL}" \
              api ./bin/migrator migrate up
            echo "Migrations applied successfully"

            # Step 2: Rolling restart of API with health check gate
            docker compose up -d --no-deps api
            sleep 10
            if ! docker compose exec api wget -qO- http://localhost:8080/health; then
              echo "Health check failed — rolling back API"
              docker compose up -d --no-deps --scale api=0
              docker compose up -d --no-deps api  # Restarts with previous image
              exit 1
            fi

            # Step 3: Restart worker
            docker compose up -d --no-deps worker

            echo "Deploy complete: ${IMAGE_TAG}"
```

> **Security note:** The `deploy` user on the VPS has execute permissions only on `/opt/iap-system` and Docker Compose commands. It does NOT have sudo access. SSH key is scoped to this user only.

---

## 9. Testing Strategy

### 9.1 Test Types

| Type | Coverage | Tools | Trigger |
|------|----------|-------|---------|
| Unit | Domain + Application layer | Go `testing`, Jest | Every commit |
| Integration | API + DB + Redis | Testcontainers | Every PR |
| E2E (Mobile) | Full user flows | Detox | Before release |
| Load | Rate limiting, hot paths | k6 | Monthly + pre-release |

**Coverage targets:** Domain layer ≥ 90%, Application layer ≥ 80%, Integration ≥ 70% of endpoints.

### 9.2 Critical Test Scenarios

```yaml
IAP Verification:
  - Valid receipt → subscription activated
  - Duplicate receipt (same receipt_hash) → 400 RECEIPT_DUPLICATE, no double activation
  - Expired receipt → 400 RECEIPT_EXPIRED
  - Apple endpoint timeout → purchase queued, returns 202, subscription activated on retry
  - Receipt with mismatched product_id → 422 UNPROCESSABLE

Subscription Lifecycle:
  - Active → Cancel → grace_started event written → expires → subscription_expired event
  - Active → payment failed webhook → grace period created → resolved → subscription active
  - Cancelled → churn score > 0.7 → winback_campaign created → offer accepted → resubscribed

Webhook Idempotency:
  - Same Stripe event_id delivered twice → second delivery returns 200 with no DB change
  - Apple DID_FAIL_TO_RENEW → grace period created (once, idempotent)
  - Google SUBSCRIPTION_CANCELED → subscription cancelled (once, idempotent)

A/B Testing:
  - New user → assigned to one group only (@@unique constraint enforced)
  - Assignment returned consistently for same user
  - Event tracking → results aggregated correctly

Token Revocation:
  - Valid JWT → access granted
  - Revoked JWT (jti in blocklist) → 401 TOKEN_REVOKED
  - Expired JWT → 401 TOKEN_EXPIRED

Admin RBAC:
  - analyst role → cannot grant subscription → 403 INSUFFICIENT_ROLE
  - ops role → can grant subscription → audit log entry written in same transaction
  - super_admin → can update pricing tier → audit log written
```

### 9.3 Test Commands

```bash
# Backend
make test              # All tests with race detector
make test-unit         # Unit tests: domain + application
make test-integration  # Integration tests (requires Docker)
make test-coverage     # Coverage report (fail below 80%)
make test-load         # k6 load tests

# Mobile
npm run test           # Jest unit tests
npm run test:e2e       # Detox E2E (requires connected device/emulator)
```

---

## 10. Monitoring & Observability

### 10.1 Business Metrics

```yaml
Revenue:
  - mrr_total: gauge — current MRR from revenue_aggregates
  - arr_total: gauge — current ARR
  - subscription_active_count: gauge
  - subscription_churn_rate: gauge — (churned / previous_active) per day
  - ltv_average: gauge

Conversion:
  - paywall_shown_total: counter (by ab_test_group)
  - purchase_completed_total: counter (by platform, plan_type)
  - conversion_rate: gauge — purchase / shown (by group)

Retention:
  - grace_period_active_count: gauge
  - grace_period_resolved_rate: gauge
  - winback_conversion_rate: gauge
```

### 10.2 Technical Metrics

```yaml
API:
  - http_request_duration_seconds: histogram (by endpoint, method, status_code)
  - http_requests_total: counter (by endpoint, status_code)
  - rate_limit_exceeded_total: counter (by endpoint)

Infrastructure:
  - db_pool_connections_used: gauge
  - db_pool_connections_idle: gauge
  - redis_memory_used_bytes: gauge
  - asynq_queue_depth: gauge (by queue name)
  - asynq_job_failures_total: counter (by job type)

External Services:
  - iap_verification_duration_seconds: histogram (by provider)
  - iap_verification_errors_total: counter (by provider, error_type)
  - lago_api_duration_seconds: histogram
  - lago_circuit_breaker_state: gauge (0=closed, 1=open)
```

### 10.3 Prometheus Configuration

```yaml
# infra/monitoring/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'api'
    static_configs:
      - targets: ['api:8080']
    metrics_path: '/metrics'

  - job_name: 'worker'
    static_configs:
      - targets: ['worker:9090']

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

### 10.4 Alerting Rules

```yaml
# infra/monitoring/prometheus/rules/alerts.yml
groups:
  - name: critical
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "API error rate above 5%"

      - alert: DatabaseDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical

      - alert: AccessCheckLatencyHigh
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{endpoint="/subscription/access"}[5m])) > 0.2
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "Access check P99 > 200ms — cache may be cold"

      - alert: WebhookQueueBacklog
        expr: asynq_queue_depth{queue="webhooks"} > 100
        for: 5m
        labels:
          severity: high

      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.20
        for: 5m
        labels:
          severity: high

  - name: business
    rules:
      - alert: HighChurnRate
        expr: subscription_churn_rate > 0.05
        for: 24h
        labels:
          severity: warning
        annotations:
          summary: "Daily churn rate exceeds 5% — review winback campaigns"

      - alert: LagoCircuitBreakerOpen
        expr: lago_circuit_breaker_state == 1
        for: 2m
        labels:
          severity: high
```

### 10.5 Structured Log Format

```json
{
  "timestamp": "2026-02-28T12:00:00Z",
  "level": "info",
  "service": "api",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": "550e8400-e29b-41d4-a716-446655440001",
  "endpoint": "/verify/iap",
  "method": "POST",
  "status_code": 200,
  "duration_ms": 145,
  "platform": "ios",
  "message": "Receipt verified successfully"
}
```

All logs are structured JSON. No `fmt.Println` or unstructured log output in any service.

---

## 11. Development Phases

### 11.1 MVP Scope

**Target:** Core IAP purchase flow, receipt verification, subscription management.

```yaml
Included:
  - User registration (platform_user_id identity model)
  - IAP purchases: iOS + Android
  - Receipt verification via go-iap with fallback cache
  - Subscription CRUD
  - JWT auth with revocation
  - Webhook inbox (idempotency) for Stripe + Apple + Google
  - Simple paywall UI (one variant)
  - Lago sandbox integration
  - Subscription event audit log
  - Basic Prometheus metrics + Grafana dashboard

Excluded from MVP:
  - Grace period automation (worker)
  - Winback campaigns
  - A/B testing
  - Advanced analytics (cohorts, funnels)
  - Churn prediction
  - Admin RBAC (use single super_admin for MVP)
```

### 11.2 Full Production Scope

```yaml
Additional Features:
  - Grace period worker + API
  - Winback campaign worker + API
  - A/B testing engine
  - Revenue aggregate worker
  - Full analytics API
  - Churn prediction worker (rule-based scoring)
  - Full Admin RBAC (4 roles)
  - Admin audit log
  - Multi-currency pricing tier support
  - GDPR data export + erasure endpoints
```

### 11.3 Phase Plan

| Phase | Deliverables |
|-------|-------------|
| **1 — Setup** | Repos, VPS, CI/CD pipeline, docker-compose, monitoring skeleton |
| **2 — Data Layer** | Migrations, sqlc codegen, repository implementations, connection pool config |
| **3 — Backend Core** | Auth + JWT revocation, IAP verification + fallback, webhook inbox, subscription CRUD |
| **4 — Mobile App** | React Native, react-native-iap, paywall UI, API integration |
| **5 — Integration** | E2E tests, load tests, bug fixes, Lago sandbox validation |
| **6 — Production** | Grace periods, winback, A/B testing, admin RBAC, churn scoring, analytics |
| **7 — Security** | GDPR endpoints, penetration test, compliance checklist, runbook review |

---

## Appendices

### Appendix A: Churn Risk Score Algorithm

The churn risk score is computed nightly by `churn_prediction_job`. No external ML model is required — the score uses a weighted rule-based formula.

```
risk_score = (
    w1 * normalize(days_inactive,      min=0,  max=90)  +
    w2 * normalize(failed_payments,    min=0,  max=5)   +
    w3 * (1 - normalize(engagement,   min=0,  max=100)) +
    w4 * (1 - normalize(sub_age_days, min=0,  max=730))
)

Weights:
  w1 (days_inactive):   0.35
  w2 (failed_payments): 0.35
  w3 (low_engagement):  0.20
  w4 (new_subscriber):  0.10

normalize(x, min, max) = clamp((x - min) / (max - min), 0, 1)

Thresholds:
  score < 0.3:  low risk    → no action
  score 0.3-0.7: medium risk → monitor
  score > 0.7:  high risk   → trigger winback campaign if subscription is still active
  score > 0.8:  critical    → trigger proactive discount offer via notification
```

Factors stored in `churn_predictions.factors`:
```json
{
  "days_inactive": 14,
  "failed_payments": 1,
  "engagement_score": 42,
  "subscription_age_days": 180
}
```

### Appendix B: Environment Variables

```bash
# .env.example — all values are placeholders, never commit real values

# Database
DATABASE_URL=postgresql://appuser:CHANGE_ME@localhost:5432/iap_db
DB_USER=appuser
DB_NAME=iap_db
DB_PASSWORD=CHANGE_ME

# Redis
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=CHANGE_ME

# Auth
JWT_SECRET=CHANGE_ME_min_32_chars
JWT_ACCESS_TTL=15m
JWT_REFRESH_TTL=720h

# External — IAP
APPLE_SHARED_SECRET=CHANGE_ME
GOOGLE_SERVICE_ACCOUNT_JSON=/run/secrets/google-service-account.json

# External — Billing
LAGO_API_KEY=CHANGE_ME
LAGO_WEBHOOK_SECRET=CHANGE_ME

# External — Payments
STRIPE_SECRET_KEY=sk_test_CHANGE_ME
STRIPE_WEBHOOK_SECRET=whsec_CHANGE_ME
PADDLE_API_KEY=CHANGE_ME
PADDLE_WEBHOOK_SECRET=CHANGE_ME

# Backup
BACKUP_ENCRYPTION_KEY=CHANGE_ME_min_32_chars
BACKUP_BUCKET=your-backup-bucket
KMS_KEY_ID=arn:aws:kms:REGION:ACCOUNT:key/KEY_ID
AWS_ACCESS_KEY_ID=CHANGE_ME
AWS_SECRET_ACCESS_KEY=CHANGE_ME

# mTLS (server-to-server only)
MTLS_CA_CERT=/run/secrets/ca.crt
MTLS_CLIENT_CERT=/run/secrets/client.crt
MTLS_CLIENT_KEY=/run/secrets/client.key

# Sentry
SENTRY_DSN=https://CHANGE_ME@sentry.io/PROJECT_ID
```

### Appendix C: Makefile

```makefile
# backend/Makefile
.PHONY: build test test-unit test-integration test-coverage test-load lint fmt migrate sqlc

build:
	go build -o bin/api ./cmd/api
	go build -o bin/worker ./cmd/worker
	go build -o bin/migrator ./cmd/migrator

sqlc:
	sqlc generate

test:
	go test ./... -race -count=1

test-unit:
	go test ./internal/domain/... ./internal/application/... -race

test-integration:
	go test ./tests/integration/... -tags=integration -race

test-coverage:
	go test ./... -race -coverprofile=coverage.out
	go tool cover -func=coverage.out
	@awk '/^total:/ { if ($$3+0 < 80) { print "Coverage below 80%: " $$3; exit 1 } }' coverage.out

test-load:
	k6 run tests/load/rate-limit.js

migrate:
	go run ./cmd/migrator migrate up

migrate-down:
	go run ./cmd/migrator migrate down 1

lint:
	golangci-lint run

fmt:
	go fmt ./...
	goimports -w .

docker-up:
	docker compose -f ../infra/docker-compose/docker-compose.dev.yml up -d

docker-down:
	docker compose -f ../infra/docker-compose/docker-compose.dev.yml down
```

### Appendix D: Threat Model Summary (STRIDE)

| Threat | Vector | Mitigation |
|--------|--------|------------|
| Spoofing | Forged IAP receipt | go-iap server-side verification against Apple/Google |
| Spoofing | Webhook impersonation | HMAC-SHA256 + IP allowlist |
| Spoofing | Mobile client mTLS bypass | mTLS not used for mobile — cert pinning used instead |
| Tampering | Receipt replay | `receipt_hash` unique index in transactions table |
| Tampering | Webhook replay | `(provider, event_id)` unique index in webhook_events |
| Repudiation | Admin denies action | `admin_audit_logs` written in same transaction as action |
| Info Disclosure | Backup PII exposure | AES-256 + S3 KMS encryption before upload |
| Info Disclosure | JWT theft | Short TTL (15m) + jti revocation blocklist |
| Info Disclosure | DB credential exposure | Secrets via environment, never in committed files |
| DoS | Webhook flood | IP allowlist + rate limit (200/min) |
| DoS | Receipt verification abuse | 3/min/user + 5/min/IP rate limit + 10/day hard cap |
| Elevation of Privilege | Root SSH compromise | Non-root deploy user with scoped permissions |
| Elevation of Privilege | Static admin key | RBAC admin JWT with 1h TTL and role claims |
| Elevation of Privilege | Dual A/B assignment | `UNIQUE (test_id, user_id)` enforced at DB level |

---

**END OF SPECIFICATION**

For questions or clarifications, contact the Architecture Team.
