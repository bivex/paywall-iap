name: Load Tests

on:
  schedule:
    - cron: '0 2 * * 0' # Run weekly on Sunday at 2 AM
  workflow_dispatch: # Allow manual trigger

jobs:
  load-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        
    - name: Start Application Stack (Docker Compose)
      working-directory: ./infra/docker-compose
      run: docker compose -f docker-compose.dev.yml up -d
      
    - name: Wait for API
      run: sleep 10 # Wait for app to become ready
      
    - name: Run Basic Load Test
      working-directory: ./backend
      run: make test-load
      
    # Optionally, we might upload artifacts or push to grafana cloud
